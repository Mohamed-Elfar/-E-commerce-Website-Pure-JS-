import{showToast as e,addToCart as t,redirectToNotFoundPage as n,toggleWishList as s,loginUser as i}from"/assets/js/utils.js";import{creatProductCard as a,fetchResponse as o}from"/assets/js/main.js";const r=parseInt(new URLSearchParams(location.search).get("id")),d=JSON.parse(localStorage.getItem("allProducts")||[]),c=d.find((e=>e.id===r)),l=i();n(!r||isNaN(r)||!c);const m=document.getElementById("productName"),u=document.getElementById("productQuantity"),g=document.getElementById("productPrice"),y=document.getElementById("productDesc"),p=document.getElementById("sideImgs"),f=document.getElementById("mainImg"),I=document.getElementById("reviewsList"),v=document.getElementById("reviewsNumber"),E=document.getElementById("reviewInput"),B=document.getElementById("addReviewBtn"),h=document.getElementById("ratingCount"),L=document.getElementById("ratingStars"),x=document.getElementById("addToCartBtn"),C=document.getElementById("wishListBtn"),w=document.querySelector(".wishlist-icon"),b=document.getElementById("decreaseBtn"),S=document.getElementById("increaseBtn"),$=document.getElementById("quantity"),N=document.getElementById("totalPrice");!function(){if(c.images.length>0&&(f.src=c.images[0]),c.images.length>0){let e="";for(let t=0;t<c.images.length;t++)e+=`\n          <img\n          class="side-imgs__img img-thumbnail ${0===t?"active-img":""}"\n          src="${c.images[t]}"\n          alt="controller."\n        />\n          `;p.innerHTML=e;const t=document.querySelectorAll(".side-imgs__img");for(let e=0;e<t.length;e++)t[e].addEventListener("click",(function(e){t.forEach((e=>e.classList.remove("active-img")));let n=e.target;n.classList.add("active-img"),f.src=n.src}))}if(m.textContent=c?.name,g.textContent=`$${c?.price.toFixed(2)}`,u.textContent+=c?.quantity,y.textContent=c?.description,v.textContent=c?.reviews?.length||0,c.reviews.length>0){let e="";c?.reviews.forEach((t=>{e+=`\n      <li class="mb-3 border-bottom pb-2">\n      <strong>${t.username}</strong>\n      <small class="text-muted ms-4">${t.date}</small>\n      <p class="mt-2">${t.comment}</p>\n      </li>\n      `})),I.innerHTML=e}else I.innerHTML='<li class="text-muted">No reviews yet!</li>';h.textContent=`(${c.ratingCount})`,L.innerHTML=[...Array(5)].map(((e,t)=>`<i class="fa-${t<c.rating?"solid":"regular"} fa-star ${t<c.rating?"gold":"text-muted"}" aria-hidden="true"></i>`)).join("")}(),B.addEventListener("click",(function(){const t=E.value.trim();if(""===t)return void e("error","please add a review before submitting!");const n=localStorage.getItem("token");if(console.log(n),!n)return void e("error","please login first to add review");const s=JSON.parse(localStorage.getItem("users")||[]),i=s?.find((e=>e?.token===n));if(console.log(i),!i)return void e("error","invalid user, please login again !");const a=i.firstName+" "+i.lastName,o=(new Date).toLocaleDateString("en-CA"),r={username:a,date:o,comment:t};c?.reviews.push(r);const l=d.map((e=>e.id===c.id?c:e));localStorage.setItem("allProducts",JSON.stringify(l));const m=document.createElement("li");m.className="mb-3 border-bottom pb-2",m.innerHTML=`\n  <strong>${a}</strong>\n  <small class="text-muted ms-4">${o}</small>\n  <p class="mt-2">${t}</p>\n  `,I.appendChild(m);let u=parseInt(v.textContent);v.textContent=u+1,e("success","review added successfully"),E.value=""}));let k=c.count;function P(){$.textContent=k,b.disabled=k<=1,S.disabled=k>=c.quantity,u.classList.remove("text-success","text-danger"),c.quantity>0?(u.classList.add("text-success"),x.disabled=!1,x.textContent="Buy Now"):(u.classList.add("text-danger"),x.disabled=!0,x.textContent="Sold Out"),"Admin"===l?.role||parseInt(c?.createdBy)===l?.userId?x.disabled=!0:x.disabled=!1,parseInt(c?.createdBy)===l?.userId&&(x.textContent="u can't buy ur product");const e=k*c.price;N.textContent=`$${e.toFixed(2)}`}P(),b.addEventListener("click",(function(){k>1&&(k--,c.count=k,P())})),S.addEventListener("click",(function(){k<c.quantity&&(k++,c.count=k,P())})),x.addEventListener("click",(()=>{if(x.disabled)return;t(c)&&(window.location.href="../cart/cart.html")}));(JSON.parse(localStorage.getItem("wishlist"))||[]).includes(c.id.toString())&&(w.classList.add("active","fa-solid"),w.classList.remove("fa-regular")),C.addEventListener("click",(()=>{s(c.id.toString(),w)})),"Admin"!==l.role&&parseInt(c?.createdBy)!==l.userId||(C.disabled=!0);export function fetchSliceCategoryProducts(){const e=document.getElementById("relatedProducts");e.innerHTML="",o().then((t=>{t.filter((e=>e.category&&e.category.toLowerCase()===c.category.toLowerCase())).slice(0,4).sort((()=>Math.random()-.5)).forEach((t=>{e.appendChild(a(t))}))})).catch((()=>n(!0)))}fetchSliceCategoryProducts();